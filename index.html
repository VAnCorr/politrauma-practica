// Reemplaza estos con tus IDs reales
const SPREADSHEET_ID = '1nf8w-CkUze3nZj0EdU6kn1SqfR0IcmX9BxHWN99TfiU'; 
const FOLDER_ID = '1PblGE--Eg8O702fvKenwZ2cJFucHOsVv';

/**
 * Sirve el archivo HTML (index.html) como una aplicación web.
 */
function doGet() {
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); // Permite incrustar en otros sitios si es necesario
}

/**
 * Procesa los datos del formulario, los guarda en Google Sheet y genera un PDF en Google Drive.
 * @param {Object} formData - Objeto con los datos del formulario enviados desde el cliente.
 * @returns {Object} Un objeto con un mensaje de éxito o error.
 */
function processForm(formData) {
  try {
    // 1. Guardar datos en Google Sheet
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('Hoja 1') || ss.getSheets()[0]; // Asegura que 'Hoja 1' existe o toma la primera hoja

    // Encabezados esperados en tu hoja:
    // Timestamp, Fecha, Residente, Evaluador, Organización del equipo (10%), Control de vía aérea (20%), Ventilación (15%), Circulación (25%), Evaluación neurológica (10%), Exposición (10%), Valoración secundaria (10%), Nota Final, Estado Calificación, Comentarios
    
    // Preparar los datos de los criterios en el orden de tu Sheet
    const criteriosValues = [];
    const criteriosMap = {};
    formData.criterios.forEach(c => {
      // Eliminar el prefijo numérico (ej. "1. ") para la clave del mapa, pero mantener el nombre completo
      const cleanName = c.nombre.split('. ').slice(1).join('. ').trim(); // "Organización del equipo"
      criteriosMap[c.nombre] = c.puntuacion; // Mapear por nombre completo para fácil acceso
    });

    // Definir el orden exacto de los criterios como aparecen en tu hoja de Google Sheets
    // Ajusta estos nombres si no coinciden exactamente con los encabezados de tu hoja
    const expectedCriteriosOrder = [
        '1. Organización del equipo',
        '2. Control de la vía aérea con protección cervical',
        '3. Ventilación y oxigenación',
        '4. Circulación y control de hemorragias',
        '5. Evaluación neurológica',
        '6. Exposición y prevención de hipotermia',
        '7. Valoración secundaria y plan definitivo'
    ];

    expectedCriteriosOrder.forEach(criterioName => {
        criteriosValues.push(criteriosMap[criterioName] !== undefined ? criteriosMap[criterioName] : '');
    });

    const rowData = [
      formData.timestamp,
      formData.fecha,
      formData.residente,
      formData.evaluador,
      ...criteriosValues, // Agrega las puntuaciones de los criterios en el orden definido
      formData.notaFinal,
      formData.estadoCalificacion,
      formData.comentarios
    ];

    sheet.appendRow(rowData);

    // 2. Generar y guardar PDF en Google Drive
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const pdfFileName = `Rúbrica - ${formData.residente} - ${formData.fecha}.pdf`;

    // Construir contenido HTML para el PDF (simplificado para mejor compatibilidad con la conversión a PDF en Google Docs)
    let pdfHtmlContent = `
      <html>
        <head>
          <title>Rúbrica de Evaluación</title>
          <style>
            body { font-family: 'Arial', sans-serif; margin: 30px; line-height: 1.6; color: #333; font-size: 11pt; }
            h1 { font-size: 20pt; color: #1a73e8; text-align: center; margin-bottom: 5px; }
            h2 { font-size: 16pt; color: #3c4043; text-align: center; margin-bottom: 20px; }
            h3 { font-size: 14pt; color: #3c4043; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            p { margin-bottom: 8px; }
            strong { color: #5f6368; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
            th { background-color: #f8f8f8; color: #333; font-weight: bold; }
            .score { font-weight: bold; color: #16a34a; } /* Color para las puntuaciones */
            .final-score-section { 
                margin-top: 30px; 
                padding: 20px; 
                background-color: #e8f0fe; 
                border: 1px solid #c5dafc; 
                border-radius: 8px; 
                text-align: center;
            }
            .final-score-value { 
                font-size: 32pt; 
                font-weight: bold; 
                color: #1a73e8; 
                margin-bottom: 10px; 
                text-shadow: 1px 1px 2px rgba(0,0,0,0.1); 
            }
            .status-text { 
                font-size: 12pt; 
                color: #5f6368; 
                padding: 5px 10px; 
                border-radius: 5px; 
                display: inline-block;
                background-color: #dcfce7; /* Default green */
                color: #16a34a;
                border: 1px solid #22c55e;
            }
            .status-excellent { background-color: #dcfce7; color: #16a34a; border-color: #22c55e; }
            .status-good { background-color: #fef3c7; color: #d97706; border-color: #fde68a; }
            .status-acceptable { background-color: #ffeccf; color: #ea580c; border-color: #fdba74; }
            .status-poor { background-color: #fecaca; color: #dc2626; border-color: #fca5a5; }

            .comments-section { margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 20px; }
            .footer-info { font-size: 9pt; color: #777; text-align: center; margin-top: 50px; }
          </style>
        </head>
        <body>
          <h1>Rúbrica de Evaluación Práctica</h1>
          <h2>Curso: "El Paciente Politraumatizado"</h2>
          <p><strong>Fecha de Evaluación:</strong> ${formData.fecha}</p>
          <p><strong>Nombre del Residente:</strong> ${formData.residente}</p>
          <p><strong>Nombre del Evaluador:</strong> ${formData.evaluador}</p>
          
          <h3>Criterios de Evaluación</h3>
          <table>
            <thead>
              <tr>
                <th>Criterio</th>
                <th>Puntuación</th>
                <th>Peso</th>
              </tr>
            </thead>
            <tbody>
    `;

    formData.criterios.forEach(criterio => {
      pdfHtmlContent += `
              <tr>
                <td>${criterio.nombre}</td>
                <td class="score">${criterio.puntuacion}%</td>
                <td>${criterio.peso}%</td>
              </tr>
      `;
    });

    let statusClass = '';
    const finalScoreValue = parseFloat(formData.notaFinal.replace('%', ''));
    if (finalScoreValue >= 80) {
        statusClass = 'status-excellent';
    } else if (finalScoreValue >= 70) {
        statusClass = 'status-good';
    } else if (finalScoreValue >= 60) {
        statusClass = 'status-acceptable';
    } else {
        statusClass = 'status-poor';
    }

    pdfHtmlContent += `
            </tbody>
          </table>
          
          <div class="final-score-section">
            <h3>Calificación Final</h3>
            <div class="final-score-value">${formData.notaFinal}</div>
            <span class="status-text ${statusClass}">${formData.estadoCalificacion}</span>
          </div>
          
          <div class="comments-section">
            <h3>Comentarios y Observaciones</h3>
            <p>${formData.comentarios ? formData.comentarios.replace(/\n/g, '<br>') : 'N/A'}</p>
          </div>
          <p class="footer-info">Generado el: ${formData.timestamp}</p>
        </body>
      </html>
    `;

    // Crear un archivo temporal HTML en Drive
    const tempHtmlFile = DriveApp.createFile('temp_rubrica.html', pdfHtmlContent, MimeType.HTML);
    
    // Convertir el archivo HTML a PDF
    const pdfBlob = tempHtmlFile.getAs(MimeType.PDF);
    
    // Guardar el PDF en la carpeta especificada
    folder.createFile(pdfBlob).setName(pdfFileName);
    
    // Eliminar el archivo temporal HTML (para no dejar basura)
    tempHtmlFile.setTrashed(true); // Mover a la papelera

    return { success: true, message: 'Datos guardados en Google Sheets y PDF generado en Drive correctamente.' };

  } catch (e) {
    Logger.log('Error en processForm: ' + e.message); // Registra el error para depuración
    return { success: false, message: 'Error al procesar el formulario: ' + e.message };
  }
}
